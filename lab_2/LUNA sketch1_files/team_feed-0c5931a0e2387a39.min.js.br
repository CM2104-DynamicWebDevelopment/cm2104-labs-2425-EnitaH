"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="68b01c27-30f2-56df-81ea-8b30edd3637a")}catch(e){}}();
(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[5099],{975723:(e,t,l)=>{l.r(t),l.d(t,{EditFeedPostModal:()=>Z});var n=l(411855),a=l(188507),d=l(629019),o=l.n(d),i=l(776250),s=l(609494),r=l(966712),c=l(498750),u=l(915440),m=l(27087),f=l(448169),p=l(946689),y=l(493323),g=l(881388),h=l(939863),C=l(392592),b=l(507877),I=l(662275),P=l(654034),E=l(694687),k=l(860178),_=l(279453),F=l(204279),v=l(531827),x=l(28588),T=l(103271),K=l(588282),M=l(126674),S=l(679736),N=l(406158),w=l(757022),D=l(583630),O=l(660040),U=l(160156),A=l(461839),R=l(462256),z=l(782680),Y=l(722388),B=l(674222);function Z(e){let t=(0,a.wA)(),l=n.useCallback(()=>{t(I.Ce())},[t]),d=(0,h.tx)("fig_feed.edit_post"),o=e.feedPostUuid;!o&&e.feedPostThreadId&&(o=(0,K.gk)(e.feedPostThreadId));let i=(0,u.Rs)(_.FHz,{publicUuid:o},{enabled:!e.preloadedFeedPost&&!!o}),s=n.useMemo(()=>e.preloadedFeedPost?e.preloadedFeedPost:"loaded"===i.status?i.data.feedPost:null,[e.preloadedFeedPost,i]);return n.createElement(R.j,{title:d,onClose:l},s?n.createElement(q,{onSubmitSuccess:e.onSubmitSuccess,entryPoint:e.entryPoint,lockedFileKey:e.lockedFileKey,feedPost:s}):n.createElement("div",{className:B._5},n.createElement(y.kt,{size:"large"})))}function q(e){let t=(0,a.wA)(),l=(0,E.sZ)(),d=(0,k.iZ)(),[u,_]=n.useState(!0),[K,R]=n.useState(!1),[Z,q]=n.useState(!1),L=e.feedPost.publicUuid,$=n.useMemo(()=>e.feedPost.content.map(e=>JSON.parse(e)),[e.feedPost]),[j,J]=n.useState($.reduce((e,t)=>{if(t.type!==T.cM.NODE)return e;e.fileKey=t.fileKey;let l=t.nodeId;return e.nodeIds.push(l),e},{fileKey:e.feedPost.fileKey||"",nodeIds:[]})),V=n.useMemo(()=>{let e=$.find(e=>e.type===T.cM.PROTOTYPE);return e?{fileKey:e.fileKey,pageId:e.pageId,startingNodeId:e.startingNodeId}:null},[$]),[H,Q]=n.useState(0),X=n.useCallback(()=>{t(I.Ce())},[t]),G=n.useCallback(()=>{t((0,I.to)({type:z.h,data:{onConfirm:X},showModalsBeneath:!0}))},[t,X]),W=e.lockedFileKey||j?.fileKey||V?.fileKey;n.useEffect(()=>{let t={entryPoint:e.entryPoint};W&&(t.fileKey=W),(0,i.sx)("Team Feed Edit Post Modal Opened",t)},[e.entryPoint,W]);let ee=n.useCallback((e,n,a)=>{if(n){t(I.Ce());return}let d={text:(0,h.t)("fig_feed.view_post"),action:()=>{t(b.V3({url:(0,M.Kc)(l.id,{uuid:e})}))}};t(C.F.enqueue({message:(0,h.t)("fig_feed.post_edited"),button:a?d:void 0})),t(I.Ce())},[t,l]),[et,el]=n.useState($.map(e=>{let t=(0,N.EU)(e),l=(0,T.aT)(e)&&!!e.hasPreviousEditPreview,n={...e,copiedToS3:e.type===T.cM.NODE||e.type===T.cM.PROTOTYPE,shouldBlockEditPreview:l&&!t};return{displayContentItem:n,processedContentItem:Promise.resolve(n)}})),en=n.useMemo(()=>new Set(et.map(e=>e.displayContentItem.type===T.cM.NODE?e.displayContentItem.nodeId:null).filter(e=>null!==e)),[et]);n.useEffect(()=>{(0,w.sr)(j,en,el,l?.id)},[j,en,el,l?.id]);let ea=n.useCallback(e=>{let t=(0,U.K1)(et[H].displayContentItem);Q(e.findIndex(e=>(0,U.K1)(e)===t));let l=[];e.forEach(e=>{let t=(0,U.K1)(e),n=et.find(e=>(0,U.K1)(e.displayContentItem)===t);n?l.push(n):console.error("Expected to have a matchedPendingItem")}),el(l)},[et,H]),ed=n.useCallback(e=>{Q(et.findIndex(t=>(0,U.K1)(t.displayContentItem)===e))},[et]),{setContentPreview:eo,snapshotStates:ei}=(0,w.eh)(et,el),{onSubmitSuccess:es}=e,er=n.useCallback((l,n)=>{m.Ay.put(`/api/feed_posts/${L}`,l).then(l=>{ee(l.data.meta.public_uuid,n,e.entryPoint===S.M2.FILE),n&&t(C.F.enqueue({message:(0,h.t)("fig_feed.post_submission_pending")})),es&&es(n)}).catch(()=>{t(g.s.error((0,h.t)("fig_feed.error_on_feed_post_creation"))),_(!1)})},[t,ee,es,L,e.entryPoint]),[ec,eu]=n.useState(e.feedPost.title||""),[em,ef]=n.useState((0,P.o8)(e.feedPost.descriptionMeta)),ep=n.useMemo(()=>({library:new v.M8(l.id)}),[l]);n.useEffect(()=>{_(ec.trim().length>O.Y||(0,s._Z)(em).length>O.e||0===et.length)},[ec,em,et.length]);let ey=async n=>{if(!l||u)return;n?.preventDefault(),_(!0);let a={description_meta:em,org_id:l.id},d=(0,s._Z)(em);a.content=await (0,N.pj)(t,et,W??"",ec),(0,i.sx)("team_feed_content_awaited",{payloadContent:JSON.stringify(a.content)},{logFromProber:!0});let o=a.content.some(e=>e.pending);ec?a.title=ec:a.title=d.length>0?d.slice(0,40)+"\u2026":(0,h.t)("fig_feed.untitled_post"),W&&(a.attached_file_key=W),er(a,o),(0,i.sx)("Team Feed Post Edited",{fileKey:W,entryPoint:e.entryPoint,text:d,numContentItems:a.content.length,contentItemTypes:a.content.map(e=>e.type)},{forwardToDatadog:!0})},eg=n.useCallback((e,n)=>{if(!l)return;let a=Array.from(e);if(0===a.length)return;let d=(0,F.KT)(a,et.length,T.e3,T.bB,e=>{t(C.F.enqueue({message:(0,A.getUploadErrorMessage)(e)}))},et.map(e=>e.fileIdentifier)).map(e=>{let t=(0,F.Fn)(e);if(x.xp.includes(e.type))return(0,N.zr)(t,e);if(x.VY.includes(e.type))return(0,N.X2)(t,L,l.id,e);throw Error("unexpected file type")}),o=void 0!==n?n:et.length;el(e=>[...e.slice(0,o),...d,...e.slice(o)]),Q(o)},[t,l,L,et]),eh=n.useCallback((e,t)=>()=>{let l=e.current?.files||null;null!==l&&0!==l.length&&(eg(l,t),e.current&&(e.current.value=""))},[eg]),eC=n.useCallback(e=>{let t=Math.min(e,Math.max(0,et.length-2)),l=et[e];if((0,N.AK)(l),el(t=>t.filter((t,l)=>l!==e)),l.displayContentItem.type===T.cM.NODE){let e=l.displayContentItem.nodeId;J(t=>{if(t){let l=t.nodeIds.filter(t=>t!==e),n=t.nodeThumbnails,a=n&&l.reduce((e,t)=>(e[t]=n[t],e),{});return{...t,nodeIds:l,nodeThumbnails:a}}return null})}Q(t)},[et]),eb=n.useCallback((e,t)=>{eg(e.files,t),q(!1)},[eg]),eI=n.useRef(null),eP=!!j?.nodeIds?.length,{openPostFromFileModal:eE,attachedFileData:ek}=(0,w.Ld)({setLinkedFileNodeInfo:J,numUserContentItems:et.length,hasNodeContent:eP,parentModalRef:eI,attachedFileKey:W,lockedFileKey:e.lockedFileKey,currentOrgId:l?.id}),e_=n.useCallback(()=>{let t=et.map(e=>e.displayContentItem);return n.createElement(f.Y,{className:o()(B.xe,Z&&B.w8),isDragTarget:()=>!0,onTargetDragEnter:()=>q(!0),onTargetDragLeave:()=>q(!1),onTargetDrop:e=>eb(e)},n.createElement(U.Zo,{contentItems:t,staticContent:!0,scrollable:!1,deleteItemAtIdx:K?void 0:eC,pageBackgroundColor:e.feedPost.backgroundColor??void 0,onReorderCallback:K?void 0:ea,shouldScrollToIndex:null,selectedIdx:H,setSelectedIdx:Q,onFileInputChange:eh,setSelectedContent:ed,snapshotStates:ei,setContentPreview:eo,openPostFromFileModal:eE,attachedFile:ek,dragging:Z,mode:"edit"}))},[e.feedPost,Z,ea,eC,K,et,eb,H,eh,ed,ei,eo,eE,ek]),eF=n.useCallback(e=>{e.keyCode===c.Uz.ESCAPE&&X()},[X]);return l&&d&&(0,r.kc)().xr_debounce_threshold?n.createElement("div",{className:B.RO,onKeyDown:eF,role:"textbox",tabIndex:0,ref:eI},n.createElement("div",{className:B.q3},e_(),l&&d?n.createElement("div",{className:B.DA},n.createElement(D.FeedPostUnifiedComposer,{user:d,currentOrgId:l.id,autofocus:!0,mentionables:ep,onSubmit:u?void 0:ey,submitOnEnter:!1,hideSubmitButton:!0,description:em,updateDescription:ef,title:ec,updateTitle:eu,displayDecoratorsDownwards:!0,minimized:!1,readOnly:K,editableTypeaheadClass:Y.up,openPostFromFileModal:()=>eE({skipFrameSelection:!eP}),fileData:ek,lockFileAddition:et.length>=T.e3,parentRef:eI,canUnlinkFile:!eP&&!e.lockedFileKey,unlinkFile:()=>J(null)})):null),n.createElement("div",{className:B.CQ},n.createElement("div",{className:B._f}),n.createElement("div",{className:B.UD},n.createElement(p.nR,{onClick:e=>{e.stopPropagation(),G()}},(0,h.tx)("fig_feed.discard_edit")),n.createElement(p.$$,{onClick:e=>{if(!K)return R(!0),ey(e).finally(()=>{R(!1)})},disabled:u,dataTestId:"feed-post-post",className:K?B.zb:B.pb},K&&n.createElement("div",{className:B.YI},n.createElement(y.kt,{shouldMatchTextColor:!0,size:"medium"})),K?(0,h.tx)("fig_feed.saving"):(0,h.tx)("general.save"))))):null}}}]);

//# debugId=68b01c27-30f2-56df-81ea-8b30edd3637a

//# sourceMappingURL=https://admin.figma.com/admin/webpack-artifacts/fc814e43c4250d722029ba090e1b22d0e427494f/team_feed-0c5931a0e2387a39.min.js.map